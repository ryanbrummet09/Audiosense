all functions here are from one function.  The original funciton was broken
into several functions to simplify the code (easier to follow and debug)
